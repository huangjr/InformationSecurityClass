# a22727_HW4_report 

## 建置環境  
MacOS Sierra 10.12.6. Python 3  

## 操作方式與執行結果
* 初始化RSA的p與q長度  

  指令： (python ./Rsa.py init {bit長度})
  > python ./Rsa.py init 10  
  
  執行結果：  
  ![](https://i.imgur.com/8Nq2F8S.png)  
  第一行是印出bit的長度，第二,三行是p與q的數字以及執行過miller_rabin Test是否為prime的結果,第四,五行是e與d,第六行是印出gcd(e, phi_n)的結果,
  第七行是印出e*d % phi_n的結果，確認兩項都是1表示程式碼產生出來的e與d是正確的。第八行則是印出n的數字。上述的數字會用到後面指令的加解密。  
  
* RSA加密  

  指令： (python ./Rsa.py -e {plaintext} {n} {e})  
         設plaintext：SOS, n: 800881, e: 400439  
  > python ./Rsa.py -e SOS 800881 400439    
  
  執行結果：  
  ![](https://i.imgur.com/vdz7dwh.png)  
  印出ciphertext,這裡是㝳髵㝳,當init的bit數輸入較大時,用前面所產生出來的n以及e都會較大,在做完RSA加密後的數字也會變大,無法轉成可見字元,此時會印出
  加密後的數字,並用','相連,如下圖,先做初始化50個bit產生出n及e,再用來做加密：  
  ![](https://i.imgur.com/1OJTtI6.png)  
  此時的n為8968138575292343660932279537,e是4484069287646171830466139767,轉出來的三個加密數字6503239710066372034480909034,8593655076183664752095032237,6503239710066372034480909034
  太大,會用逗號的方式相連印出加密數字。  
  
* RSA解密  

  指令： (python ./Rsa.py -d {ciphertext} {p} {q} {d} {n})  
  設ciphertext：㝳髵㝳, p: 907, q: 883, d: 673367, n: 800881  
  > python ./Rsa.py -d 㝳髵㝳 907 883 673367 800881  
  
  執行結果：  
  ![](https://i.imgur.com/jerXjDI.png)  
  印出plaintext是SOS,與加密前的訊息一致。若ciphertext不是可見字元,而是加密後的數字,一樣可以當作解密的input,用上述的例子解密,如下圖： 
  
  > python ./Rsa.py -d 6503239710066372034480909034,8593655076183664752095032237,6503239710066372034480909034 63508718965969 141211139530273 3236007956662825865655592775 8968138575292343660932279537
  
  ![](https://i.imgur.com/RkrAb5v.png)   
  ciphertext是6503239710066372034480909034,8593655076183664752095032237,6503239710066372034480909034,而p是63508718965969, q是141211139530273, d是3236007956662825865655592775, n是8968138575292343660932279537
  
## 程式碼解說  

* RSA的Class  

寫了一個RSA的Class, 給定一個bit的長度, 會得到p, q, n, e, d, phi_n 這些與加密和解密需要用到的資訊。  

```python
class RSA():
    # bit is the length of p and q
    def __init__(self, bit):
        self.bit_length = bit
        self.p = random.getrandbits(self.bit_length)
        self.q = random.getrandbits(self.bit_length)

        # check if p and q are both prime and not 0, here we use miller_rabin function to check prime
        while self.p == 0 or miller_rabin(self.p, 4) == False:
            self.p = random.getrandbits(self.bit_length)
        while self.q == 0 or miller_rabin(self.q, 4) == False:
            self.q = random.getrandbits(self.bit_length)

        # get n
        self.n = self.p * self.q

        # get phi_n
        self.phi_n = ( self.p - 1 ) * ( self.q - 1 )

        # get e
        for i in range(self.n // 2 , 2, -1):
            if math.gcd(i, self.phi_n) == 1:
                self.e = i
                break

        # get d
        self.d = modInverse(self.e, self.phi_n)
```  

  * miller_rabin(n,k)做質數的測試      

其中RSA的Class, 會用到的function分別是miller_rabin(n,k)以及modInverse(a, m),程式碼有寫註解, miller_rabin這裡的測試次數設4, 
k越高則是質數的機會越高。  

```python
# use miller rabin test to check if n is prime, do k times in miller rabin test to enhence the accuracy
def miller_rabin(n, k):
    if n == 2 or n == 3:
        return True

    if n % 2 == 0:
        return False

    r, s = 0, n - 1
    # to get s and r from the equation: n - 1 = 2**r*s 
    while s % 2 == 0:
        r += 1
        s //= 2
    # check n for k times
    for _ in range(k):
        a = random.randrange(2, n - 2)
        # x = a**s % n 
        x = pow(a, s, n)
        if x == 1 or x == n - 1:
            continue
        # to check x**2 % n from the equation: a**(s*2j) == n−1 (mod n), if not then n is not prime
        for _ in range(r - 1):
            x = pow(x, 2, n)
            if x == n - 1:
                break
        else:
            return False
    return True
```

  * modInverse(a, m)尋找乘法反元素

在找d時用到的方法, 在phi_n下找e的乘法反元素, 心得遇到困難裡有說明因為當bit數變長後, 處理速度會很慢, 因此找d的方法改成用Euclidian algorithm。  

```python
# find a**-1 in mod m
def modInverse(a, m) : 
    m0 = m 
    y = 0
    x = 1  
    if (m == 1) : 
        return 0
    while (a > 1) :   
        # q is quotient 
        q = a // m 
        t = m   
        # m is remainder now, process 
        # same as Euclid's algo 
        m = a % m 
        a = t 
        t = y 
        # Update x and y 
        y = x - q * y 
        x = t 
    # Make x positive 
    if (x < 0) : 
        x = x + m0 
    return x
```

* RSA的初始化  

呼叫前面敘述的RSA Class, 下指令時給定一定長度的bit數, 得到相對應的RSA資訊, 如p, q, n, e, d, phi_n, 並顯示在畫面上。  

```python
    # initial the RSA, and give the length of p, q
    if sys.argv[1] == 'init':
        bit = sys.argv[2]
        rsa = RSA(int(bit))
        p = rsa.p
        q = rsa.q
        n = rsa.n
        e = rsa.e
        d = rsa.d

        print(rsa.bit_length, '=the length of bit for p and q')
        print(p, '=p', 'Is prime?', miller_rabin(p, 4))
        print(q, '=q', 'Is prime?', miller_rabin(q, 4))
        print(e, '=e')
        print(d, '=d')
        print('gcd(e, phi_n)=', math.gcd(e, rsa.phi_n))
        print('e*d % phi_n=', e*d % rsa.phi_n )
        print(n, '=n')

```


* RSA的加密  

程式碼裡有註解, 輸入的東西需要plaintext,n以及e, 但因加密過後的數字可能太大無法轉成可見字元, 若遇到該問題會在except裡印出加密過後的數字, 不然一律
皆在try裡印出加密過後的數字再轉成可見字元的樣式。  

```python
    # use RSA to encrypt, the input should be plaintext, n and e
    # the output is the ciphertext, if the number can transfer to acsii, then we can see the words
    # if the number cannot transfer to acsii, then we see the ciphered number 
    if sys.argv[1] == '-e':
        plaintext = sys.argv[2]
        n = int(sys.argv[3])
        e = int(sys.argv[4])
        ciphertext = []
        # encrypt the plaintext and transfer plaintext to ascii
        for num in [ord(char) for char in plaintext]:
            # ciphertext.append(num ** e % n)
            ciphertext.append(Square_and_Multiply(num, e, n))

        # get ciphertext
        try:
            print(''.join( [chr(number) for number in ciphertext] ))
        except:
            # if we cannot transfer the number to ascii
            print(','.join( [str(number) for number in ciphertext] ))
            print('number above is too large, cannot transfer to ascii')
```

  * 加解密都會用到Square_and_Multiply(message_num, e, n)  

利用Square_and_Multiply加快計算次方的速度, 程式碼如下, 每一輪到下一個bit時, 要先square, 若該bit是1再乘一次, 這樣會大幅降低要計算的次數, 
次方項會大大下降。

```python
def Square_and_Multiply(message_num, e, n):
    # transfer the exponent, 'e' to binary  
    H = bin(e)[2:] 
    # initial the first bit
    ciphertext_number = message_num

    # every round when we go to next bit, we square ourselves
    for i in range(1, len(H)):
        ciphertext_number = pow(ciphertext_number, 2, n)
        # if the bit is 1, we multiply 
        if int(H[i]) == 1:
            ciphertext_number = ciphertext_number * message_num % n
    return ciphertext_number
```

* RSA的解密  

輸入的input要有ciphertext, p, q, d, n, 但因加密過後的數字可能太大無法轉成可見字元, ciphertext有可能是一連串的數字用','連接, 此時會進入
try程式碼裡, 將加密過後的數字也就是ciphertext, 利用中國餘式定理解密, 但若是ciphtertext是正常的可見字元, 會進入except裡解密。

```python
    # use RSA to decrypt, the input should be ciphertext, p, q, d and n
    # the output is the plaintext
    # the input is ciphertext, it could be words or the ciphered numbers which is divided with ','
    if sys.argv[1] == '-d':
        ciphertext = sys.argv[2]
        p = int(sys.argv[3])
        q = int(sys.argv[4])
        d = int(sys.argv[5])
        n = int(sys.argv[6])
        plaintext = []
        
        # decrypt the ciphtertext and transfer ciphertext to ascii
        try:
            # if the number is too large for ascii, the format would be number,number,...
            for num in [int(char) for char in ciphertext.split(',')]:
                plaintext.append(Chinese_Remainder_Theorem(num, p, q, d, n))
        except:
            # the normal situation, the input is ascii
            for num in [ord(char) for char in ciphertext]:
                plaintext.append(Chinese_Remainder_Theorem(num, p, q, d, n))

        # get plaintext
        print(''.join( [chr(number) for number in plaintext] ))
```

 * 解密用到的Chinese_Remainder_Theorem
  
利用中國餘式定理讓解密的速度變快, 根據老師chap0809-part2的第10至12頁的內容寫出, 除此之外也同時可利用Square_and_Multiply讓跑次方的次數降低。  

```python
def Chinese_Remainder_Theorem(message_number, p, q, d, n):
    xp = message_number % p 
    xq = message_number % q
    dp = d % (p - 1)
    dq = d % (q - 1)
    yp = Square_and_Multiply(xp, dp, p)
    yq = Square_and_Multiply(xq, dq, q)
    cp = modInverse(q, p)
    cq = modInverse(p, q)
    # the equation from chinese_remainder_theorem
    x = (q * cp * yp + p * cq * yq) % n
    return x
```

## 困難與心得  
  * 程式碼跑太久  
  
  一開始寫RSA的Class, 計算出p, q, n, e, d都跑很快, 但是當init p跟q的長度到15以上，電腦開始跑不動, 每次測試都要等到好幾分鐘, 導致無法測試, 因次開始
  想原因, 分別將p, q, n, e, d註解起來, 測試是哪一段程式碼卡太久, 結果發現是在產生d的時候卡住, d是e在phi_n下的乘法反元素, 一開始我的找法很笨, 是從2開
  始一個一個測試看哪一個數字會跟e相乘後, 再mod phi_n會是1, 後來決定要改善找d的演算法, 上網查到一個方程式, 決定利用該方程式找d。
  
  * 數學不夠好
  
    * 用錯方程式找d  
  前面為了加快運算速度, 修改找d的演算法, 利用了一個數學方程式是 a**(p - 1) mod p ＝ 1, 因此可以推出 a * a**(p - 2) mod p = 1, 當下思考以為將
  a當作e, 那就可以快速找到d, d就是e的(p - 2)次方, 但是實作後, 發現如此找出來的d無法符合RSA的條件: e*d = 1 mod(phi_n), 這裡卡了一天吧，想不出來
  哪裡錯了, 覺得數學式子是對的吧, 後來才發現我們的RSA無法用該方法找到d, 因為上述的數學式子要成立, 必須符合p是prime, 但是我們的phi_n一定不會是prime,
  因為phi_n是 (p - 1) * (q - 1), 又p跟q都是prime, 質數除了2以外一定是奇數, 奇數減1一定是偶數, 兩個偶數相乘一定還是偶數, 不可能為質數, 該方法無效。
  
    * 找d用Euclidian algorithm以及Bézout’s Theorem   
  看了很久的數學公式, a = bq + r, 則gcd(a,b) = gcd(b,r), 又gcd(a,b)可以寫成 ax + by = gcd(a,b), 所以gcd(e,phi_n) = 1 可以寫成 
  e*x + phi_n*y = 1 mod(phi_n), 這樣就可以得到 e*x = 1 mod(phi_n), 此時可以用Euclidian algorithm找到 x, 也就是d。
  
    * 看不太懂The Chinese Remainder Theorem   
  雖然照抄老師在中國餘式定理pdf的演算法Chap0809-part2的第10頁到第12頁, 就可以實作找到y**d mod(n)下的結果, 少做了很多次方項後速度非常快一樣有用
  Square_and_Multiply的方法, 但是不是很懂𝑦 ≡ 𝑞×𝑐𝑝 ×𝑦𝑝+𝑝×𝑐𝑞 ×𝑦𝑞 mod𝑛 是怎麼出來的, 可能數學好一點就會看懂該公式如何來的,可以加快解密的速度。
  
  
  ## 使用1024長度的指令
  
 雖然測試程式的速度不慢, 但因為每一次的加解密都要自己下指令貼上所需要的p, q, e, d, n, 當數字太長並不方便複製貼上, 因此做了一組指令, 方便助教
直接複製指令測試, 並將執行結果貼上讓助教比對。  
 
 init的指令助教可以不用下, 這裡已經做好一組p, q, e, d, n, 執行結果圖片如下。
 > python ./Rsa.py init 1024
 
 ![](https://i.imgur.com/wzjq49z.png)
 
 > python ./Rsa.py -e ntust 2951117759045933900990873374474479651732071982190283699223510198612926881466811815578696521670398366269183656175284297839694443943220161141688829053392650235085174384805406682174104750974886859340717821236457067566938859431824486243224583440771809104798521076828848451318617496537545115839386400082469731484366349934606856233292314069252542769255706533754529777871335755263749391861404453242454757526652389013748600277837697692234798867080692764703948025353257236705839845237542243097018786976991915341864905087452194227865351150728638660997671182568304025537260286716091524564077835078432317262081962338737504863659 1475558879522966950495436687237239825866035991095141849611755099306463440733405907789348260835199183134591828087642148919847221971610080570844414526696325117542587192402703341087052375487443429670358910618228533783469429715912243121612291720385904552399260538414424225659308748268772557919693200041234865742183174967303428116646157034626271384627853266877264888935667877631874695930702226621227378763326194506874300138918848846117399433540346382351974012676628618352919922618771121548509393488495957670932452543726097113932675575364319330498835591284152012768630143358045762282038917539216158631040981169368752431829  
 
  > output: 378851709335620929377668257517236469610495816137078202875851809549735895342214335448251811893217105135553839248912146268021103073773137430780443757151873844974724849511536759479498340132597519459917223309182922346725244073497338852807987922104593615487062811415509946539172255800751491958793800980111414449541632250025682387759020814841023335397665876075393967508145088206948016667522602404048856400794161696954762161647124191480367088424223682590301164080897576115901138458573270564004307615821770768794904719832393840179816776236888221959202587514862861505569786177751708199457880647040922833206153358483777192886,1286388465277783544341662649257916514195292350565681991496070361387297205765434062901067354367062300570335967492210831783076970005758151665729287635583176879648698821769655652625682528092744415623723599887301074060184928174283832291246939776133571831320139777323282491841826427981046669548568510320489644209999089960414441156795788040493993782525832780764819249026801399713347810151839630856652596899766011618290882484543140578033175342529710796330460592771664728013729344471891226221717233420278953773361934788484443037233878182837692424126350539147263593131066821199391740794567119866866780993536975810114072234796,2330712569759971791900396658015493485549897081990764801925096721329913870913068156866811088248900624967266699897973274076804513127066974736059384331384700850100367212373265903351916070728854815807854649200502431373464102913550572019032332277266145382986932435004908467522728573451062813763103186332368519939658053256031095129597763108811440549165761665006132599870108043056733789499114337776166002301535293348577123194256173484986245145241907452664272221086427419403414532329974910326584819574990458584849933232745995399372776657826749090661144921683393226903361661806037431798680426627739029408342786866957654302358,1924645763576645992393517602406671288126731355909427349389976924790400694560374634598300489176019925734407532878925645575769349295675104080755379826183387088168374174314089980167968768964583445720827659187025538658962042389117797056519474660567832117210684769256916347667492904737709353888211941965005375883350652747909785270131656200173259771057733636576396969857236608443717004762462743269291239149147880054248365996850391312259159829762423416403841670408875322817847587349292831033323238992119325383341206018606573469272035070882326129302610609900608952538655392952350596591743530366351899362201924061874490506380,1286388465277783544341662649257916514195292350565681991496070361387297205765434062901067354367062300570335967492210831783076970005758151665729287635583176879648698821769655652625682528092744415623723599887301074060184928174283832291246939776133571831320139777323282491841826427981046669548568510320489644209999089960414441156795788040493993782525832780764819249026801399713347810151839630856652596899766011618290882484543140578033175342529710796330460592771664728013729344471891226221717233420278953773361934788484443037233878182837692424126350539147263593131066821199391740794567119866866780993536975810114072234796  
 
 ![](https://i.imgur.com/oNq5jxt.png)
 
 > python ./Rsa.py -d 378851709335620929377668257517236469610495816137078202875851809549735895342214335448251811893217105135553839248912146268021103073773137430780443757151873844974724849511536759479498340132597519459917223309182922346725244073497338852807987922104593615487062811415509946539172255800751491958793800980111414449541632250025682387759020814841023335397665876075393967508145088206948016667522602404048856400794161696954762161647124191480367088424223682590301164080897576115901138458573270564004307615821770768794904719832393840179816776236888221959202587514862861505569786177751708199457880647040922833206153358483777192886,1286388465277783544341662649257916514195292350565681991496070361387297205765434062901067354367062300570335967492210831783076970005758151665729287635583176879648698821769655652625682528092744415623723599887301074060184928174283832291246939776133571831320139777323282491841826427981046669548568510320489644209999089960414441156795788040493993782525832780764819249026801399713347810151839630856652596899766011618290882484543140578033175342529710796330460592771664728013729344471891226221717233420278953773361934788484443037233878182837692424126350539147263593131066821199391740794567119866866780993536975810114072234796,2330712569759971791900396658015493485549897081990764801925096721329913870913068156866811088248900624967266699897973274076804513127066974736059384331384700850100367212373265903351916070728854815807854649200502431373464102913550572019032332277266145382986932435004908467522728573451062813763103186332368519939658053256031095129597763108811440549165761665006132599870108043056733789499114337776166002301535293348577123194256173484986245145241907452664272221086427419403414532329974910326584819574990458584849933232745995399372776657826749090661144921683393226903361661806037431798680426627739029408342786866957654302358,1924645763576645992393517602406671288126731355909427349389976924790400694560374634598300489176019925734407532878925645575769349295675104080755379826183387088168374174314089980167968768964583445720827659187025538658962042389117797056519474660567832117210684769256916347667492904737709353888211941965005375883350652747909785270131656200173259771057733636576396969857236608443717004762462743269291239149147880054248365996850391312259159829762423416403841670408875322817847587349292831033323238992119325383341206018606573469272035070882326129302610609900608952538655392952350596591743530366351899362201924061874490506380,1286388465277783544341662649257916514195292350565681991496070361387297205765434062901067354367062300570335967492210831783076970005758151665729287635583176879648698821769655652625682528092744415623723599887301074060184928174283832291246939776133571831320139777323282491841826427981046669548568510320489644209999089960414441156795788040493993782525832780764819249026801399713347810151839630856652596899766011618290882484543140578033175342529710796330460592771664728013729344471891226221717233420278953773361934788484443037233878182837692424126350539147263593131066821199391740794567119866866780993536975810114072234796 18986366937687588855711922645781190198614194415325772767635342033424166847326932882044025598886020536045461862137067459740302922194431127899326059416799516763302326193784517640511294574219440541835736595735318344787209404995997709729453294114809946246157133512813222502433651294636303304595604217128324919823 155433515465669183698477493986982881812338034063919201263617516401778100481330610863162704334743150695468967724995032841344950820460948247807828703166089105074556407265693229100130062220979694148758787247026102013373711467196956056913885339437163140173299843219325327533994069614584757307096363986373986426533 1633675504731532102220274245644888698474557186508537424954674244078203561748959989547603043216376496990721833261118742244114273613282611426558438535610385792520314547755313831272773639194562076261551798511453638522008079444527733997696362265440168558324177179421618590226982317434822766442444146585648634128589937695347628202720561322277269136019302927009865462964709344742072986652097406813436676672032177101327506219371125129691926430237370199255923529438076213009045885172853351852217174432618997314188152996288958609229793393819754491705831477068387018210678261428350029231697778448478848307717894717917745376525 2951117759045933900990873374474479651732071982190283699223510198612926881466811815578696521670398366269183656175284297839694443943220161141688829053392650235085174384805406682174104750974886859340717821236457067566938859431824486243224583440771809104798521076828848451318617496537545115839386400082469731484366349934606856233292314069252542769255706533754529777871335755263749391861404453242454757526652389013748600277837697692234798867080692764703948025353257236705839845237542243097018786976991915341864905087452194227865351150728638660997671182568304025537260286716091524564077835078432317262081962338737504863659
 
 > output: ntust  
 
 ![](https://i.imgur.com/lHOZsl2.png)
 
 
